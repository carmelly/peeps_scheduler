#!/bin/bash
# Pre-commit hook for markdown validation
# Runs markdown checks on staged markdown files

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
    echo -e "${GREEN}✓${NC} No markdown files to check"
    exit 0
fi

echo -e "${YELLOW}ℹ${NC} Checking staged markdown files..."
echo "$STAGED_MD_FILES" | tr '\n' ' '
echo ""
echo ""

# Check each markdown file
FAILED=0
for file in $STAGED_MD_FILES; do
    echo -e "${YELLOW}→${NC} Checking: $file"
    if /home/carmelly/code/peeps-scheduler/scripts/check-md.sh "$file" > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} $file passed"
    else
        echo -e "${RED}✗${NC} $file has issues - run: ./scripts/check-md.sh --fix $file"
        FAILED=1
    fi
done

echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}✓${NC} All markdown files valid"
    exit 0
else
    echo -e "${RED}✗${NC} Commit blocked: markdown validation failed"
    echo ""
    echo "To fix issues, run:"
    echo "  ./scripts/check-md.sh --fix <file>"
    echo ""
    echo "Then stage the fixed files and commit again."
    exit 1
fi
