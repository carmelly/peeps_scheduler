#!/bin/bash
# Pre-commit hook for markdown validation
# Runs markdown checks on staged markdown files

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -z "$STAGED_MD_FILES" ]; then
    echo -e "${GREEN}✓${NC} No markdown files to check"
    exit 0
fi

echo -e "${YELLOW}ℹ${NC} Checking staged markdown files..."
echo "$STAGED_MD_FILES" | tr '\n' ' '
echo ""

# Get git root for dynamic path resolution
GIT_ROOT=$(git rev-parse --show-toplevel)

# Check if we're in a submodule using git rev-parse --show-superproject-working-tree
SUPERPROJECT=$(git rev-parse --show-superproject-working-tree 2>/dev/null || echo "")
if [ -n "$SUPERPROJECT" ]; then
    # We're in a submodule, use the submodule directory name
    SUBMODULE_NAME=$(basename "$GIT_ROOT")
    PATH_PREFIX="$SUBMODULE_NAME/"
    # Use superproject root to find scripts
    SCRIPT_ROOT="$SUPERPROJECT"
else
    # We're in the root repo or standalone
    PATH_PREFIX=""
    SCRIPT_ROOT="$GIT_ROOT"
fi

echo ""

# Run prettier and markdownlint --fix on all files at once
if $SCRIPT_ROOT/scripts/check-md.sh --fix $STAGED_MD_FILES > /dev/null 2>&1; then
    # All files are valid
    for file in $STAGED_MD_FILES; do
        git add "$file"
    done
    echo -e "${GREEN}✓${NC} All markdown files valid (auto-fixed formatting issues)"
    exit 0
else
    # Some files have unfixable issues
    for file in $STAGED_MD_FILES; do
        git add "$file"
    done
    echo -e "${RED}✗${NC} Commit blocked: markdown has unfixable issues"
    echo ""
    echo "Error details (copy for /md-fix):"
    for file in $STAGED_MD_FILES; do
        if [ -n "$PATH_PREFIX" ]; then
            $SCRIPT_ROOT/scripts/check-md.sh --errors-only "$file" 2>&1 | sed "s|^|${PATH_PREFIX}|"
        else
            $SCRIPT_ROOT/scripts/check-md.sh --errors-only "$file" 2>&1
        fi
    done
    echo ""
    echo "See documentation-conventions skill for manual fix guidance."
    exit 1
fi
